<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Scraper Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 20px auto;
            max-width: 1400px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
        }
        .scrape-form {
            padding: 30px;
            border-bottom: 2px solid #f8f9fa;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            font-size: 14px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-scrape {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-scrape:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .btn-action {
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            margin: 2px;
        }
        .btn-export {
            background: #28a745;
            border: none;
            color: white;
        }
        .btn-save {
            background: #007bff;
            border: none;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            border: none;
            color: white;
        }
        .table-container {
            padding: 30px;
            max-height: 600px;
            overflow: auto;
        }
        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .table-responsive::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
        }
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .table {
            min-width: 1200px;
            width: 100%;
            table-layout: fixed;
            margin-bottom: 0;
        }
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none;
            font-weight: 600;
            padding: 15px 8px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table td {
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-bottom: 1px solid #f8f9fa;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .no-data i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #dee2e6;
        }
        .link-icon {
            color: #667eea;
            text-decoration: none;
            margin: 0 5px;
        }
        .link-icon:hover {
            color: #764ba2;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header text-center">
                <h1><i class="fas fa-briefcase me-2"></i>Job Scraper Pro</h1>
                <p class="mb-0">Scrape jobs from 34+ portals and manage listings</p>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show m-3" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Scraping Form -->
            <div class="scrape-form">
                <form method="post" action="{% url 'dashboard:simple-scrape' %}">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label"><strong>Keywords *</strong></label>
                            <input type="text" name="keywords" class="form-control" 
                                   placeholder="Job title, company, or keywords" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><strong>Market</strong></label>
                            <select name="market" class="form-select">
                                <option value="all">All Markets</option>
                                <option value="usa">USA</option>
                                <option value="uk">UK</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><strong>Job Type</strong></label>
                            <select name="job_type" class="form-select">
                                <option value="all">All Types</option>
                                <option value="remote">Remote</option>
                                <option value="hybrid">Hybrid</option>
                                <option value="on-site">On-site</option>
                                <option value="freelance">Freelance</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><strong>Time Range</strong></label>
                            <select name="time_range" class="form-select">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><strong>Job Count</strong></label>
                            <select name="job_count" class="form-select">
                                <option value="50">50 Jobs</option>
                                <option value="100">100 Jobs</option>
                                <option value="200">200 Jobs</option>
                                <option value="500">500 Jobs</option>
                                <option value="1000">1000 Jobs</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-scrape">
                                <i class="fas fa-search me-2"></i>Start Scraping
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Scraping jobs from 34+ portals...</p>
            </div>

            <!-- Results Section -->
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-list me-2"></i>{{ job_listings|length }} Job Listings</h4>
                    <div>
                        <a href="{% url 'dashboard:export-excel' %}" class="btn btn-action btn-export">
                            <i class="fas fa-download me-1"></i>Export Excel
                        </a>
                        <button onclick="saveToGoogleSheet()" class="btn btn-action btn-save">
                            <i class="fas fa-save me-1"></i>Save to Sheet
                        </button>
                        <button onclick="deleteAllJobs()" class="btn btn-action btn-delete">
                            <i class="fas fa-trash me-1"></i>Delete All
                        </button>
                    </div>
                </div>

                {% if job_listings %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 8%;">Field</th>
                                    <th style="width: 8%;">Posted Date</th>
                                    <th style="width: 12%;">Job Title</th>
                                    <th style="width: 10%;">Company</th>
                                    <th style="width: 8%;">Company URL</th>
                                    <th style="width: 8%;">Company Size</th>
                                    <th style="width: 8%;">Job Link</th>
                                    <th style="width: 8%;">Job Portal</th>
                                    <th style="width: 10%;">Location</th>
                                    <th style="width: 6%;">First Name</th>
                                    <th style="width: 6%;">Last Name</th>
                                    <th style="width: 8%;">Title</th>
                                    <th style="width: 8%;">LinkedIn</th>
                                    <th style="width: 10%;">Email</th>
                                    <th style="width: 8%;">Phone</th>
                                    <th style="width: 6%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in job_listings %}
                                    <tr>
                                        <td>
                                            <span class="badge {% if job.is_technical %}bg-primary{% else %}bg-info{% endif %}">
                                                {% if job.is_technical %}Technical{% else %}Non-Technical{% endif %}
                                            </span>
                                        </td>
                                        <td>{{ job.posted_date|date:"m/d/Y" }}</td>
                                        <td>{{ job.job_title }}</td>
                                        <td>{{ job.company.name }}</td>
                                        <td>
                                            {% if job.company.url %}
                                                <a href="{{ job.company.url }}" target="_blank" class="link-icon" title="Company Website">
                                                    <i class="fas fa-globe"></i>
                                                </a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ job.company.size|default:"-" }}</td>
                                        <td>
                                            {% if job.job_url %}
                                                <a href="{{ job.job_url }}" target="_blank" class="link-icon" title="Job Link">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ job.source_job_portal.name|default:"-" }}</td>
                                        <td>{{ job.location }}</td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {% with name_parts=dm.decision_maker_name|split:" " %}
                                                        {{ name_parts.0 }}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {% with name_parts=dm.decision_maker_name|split:" " %}
                                                        {% if name_parts|length > 1 %}
                                                            {{ name_parts|slice:"1:"|join:" " }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {{ dm.decision_maker_title|default:"-" }}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {% if dm.decision_maker_linkedin %}
                                                        <a href="{{ dm.decision_maker_linkedin }}" target="_blank" class="link-icon" title="LinkedIn Profile">
                                                            <i class="fab fa-linkedin"></i>
                                                        </a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {{ dm.decision_maker_email|default:"-" }}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for dm in job.company.decision_makers.all %}
                                                {% if forloop.first %}
                                                    {{ dm.decision_maker_phone|default:"-" }}
                                                {% endif %}
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <button onclick="editJob({{ job.id }})" class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteJob({{ job.id }})" class="btn btn-sm btn-outline-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <h4>No job listings found</h4>
                        <p>Start scraping to see job listings here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show loading when form is submitted
        document.querySelector('form').addEventListener('submit', function() {
            document.getElementById('loading').style.display = 'block';
        });

        function saveToGoogleSheet() {
            if (confirm('Save all jobs to Google Sheet?')) {
                fetch('{% url "dashboard:save-to-sheet" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    alert('Error saving to Google Sheet: ' + error);
                });
            }
        }

        function deleteAllJobs() {
            if (confirm('Are you sure you want to delete ALL jobs? This cannot be undone!')) {
                fetch('{% url "dashboard:delete-all-jobs" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => {
                    alert('Error deleting jobs: ' + error);
                });
            }
        }

        function editJob(jobId) {
            window.location.href = `/dashboard/jobs/${jobId}/edit/`;
        }

        function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job?')) {
                fetch(`/dashboard/jobs/${jobId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => {
                    alert('Error deleting job: ' + error);
                });
            }
        }
    </script>
</body>
</html>
