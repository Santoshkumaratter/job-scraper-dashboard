{% load static %}

<form method="post" action="{% url 'dashboard:save-filter' %}" class="search-filter-form">
            {% csrf_token %}
  <input type="hidden" name="filter_id" value="{{ filter_id|default:'' }}">
  
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-gradient-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-filter me-2"></i> Job Search Filters
        </h5>
        <div>
          {% if is_saved_filter %}
          <button type="submit" class="btn btn-sm btn-light">
            <i class="fas fa-save me-1"></i> Update Filter
          </button>
                                        {% else %}
          <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#saveFilterModal">
            <i class="fas fa-save me-1"></i> Save As New Filter
          </button>
                                        {% endif %}
                            </div>
                </div>
            </div>

    <div class="card-body p-4">
      <div class="row g-3">
        <!-- Filter Name (visible only when saving) -->
        <div class="col-md-12 filter-name-field" style="display: none;">
          <div class="form-group">
            <label for="id_name" class="form-label fw-bold">Filter Name</label>
            <input type="text" class="form-control" id="id_name" name="name" value="{{ filter.name|default:'' }}" placeholder="My Custom Filter">
                        </div>
                    </div>
                    
        <!-- Keywords -->
        <div class="col-md-12">
          <div class="form-group">
            <label for="id_keywords" class="form-label fw-bold">
              <i class="fas fa-search me-1"></i> Search Keywords
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Enter keywords separated by commas (e.g., 'React Developer, Python Engineer')"></i>
            </label>
            <textarea class="form-control" id="id_keywords" name="keywords" rows="2" placeholder="e.g., Software Engineer, Python Developer, React Developer">{{ filter.keywords|default:'' }}</textarea>
            <div class="form-text small">Separate multiple keywords with commas</div>
                    </div>
                    
          <!-- Keyword Suggestions -->
          <div class="mt-2 mb-3">
            <label class="form-label small text-muted">Suggested Keywords:</label>
            <div class="keyword-suggestions d-flex flex-wrap gap-1">
              {% for keyword in suggested_keywords %}
              <button type="button" class="btn btn-sm btn-outline-secondary keyword-suggestion" data-keyword="{{ keyword }}">
                {{ keyword }}
              </button>
              {% endfor %}
                    </div>
                </div>
            </div>

        <!-- First Row of Filters -->
        <div class="col-md-4">
          <div class="form-group">
            <label for="id_keyword_type" class="form-label fw-bold">
              <i class="fas fa-laptop-code me-1"></i> Job Type
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Filter by technical or non-technical roles"></i>
            </label>
            <select class="form-select" id="id_keyword_type" name="keyword_type">
              <option value="both" {% if filter.is_technical == None %}selected{% endif %}>All Jobs</option>
              <option value="technical" {% if filter.is_technical == True %}selected{% endif %}>Technical</option>
              <option value="non_technical" {% if filter.is_technical == False %}selected{% endif %}>Non-Technical</option>
            </select>
                            </div>
                        </div>
                        
        <div class="col-md-4">
          <div class="form-group">
            <label for="id_market" class="form-label fw-bold">
              <i class="fas fa-globe-americas me-1"></i> Market
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Select which market to search in"></i>
            </label>
            <select class="form-select" id="id_market" name="market">
              <option value="" {% if not filter.market %}selected{% endif %}>All Markets</option>
              <option value="USA" {% if filter.market == 'USA' %}selected{% endif %}>USA</option>
              <option value="UK" {% if filter.market == 'UK' %}selected{% endif %}>UK</option>
            </select>
                            </div>
                        </div>
                        
        <div class="col-md-4">
          <div class="form-group">
            <label for="id_job_type" class="form-label fw-bold">
              <i class="fas fa-briefcase me-1"></i> Employment Type
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Filter by employment type"></i>
                                    </label>
            <select class="form-select" id="id_job_type" name="job_type">
              <option value="All" {% if filter.job_type == 'All' or not filter.job_type %}selected{% endif %}>All Types</option>
              <option value="full_time" {% if filter.job_type == 'full_time' %}selected{% endif %}>Full Time</option>
              <option value="part_time" {% if filter.job_type == 'part_time' %}selected{% endif %}>Part Time</option>
              <option value="contract" {% if filter.job_type == 'contract' %}selected{% endif %}>Contract</option>
              <option value="remote" {% if filter.job_type == 'remote' %}selected{% endif %}>Remote</option>
              <option value="hybrid" {% if filter.job_type == 'hybrid' %}selected{% endif %}>Hybrid</option>
              <option value="freelance" {% if filter.job_type == 'freelance' %}selected{% endif %}>Freelance</option>
            </select>
                </div>
            </div>

        <!-- Second Row of Filters -->
                        <div class="col-md-6">
                            <div class="form-group">
            <label for="id_date_range" class="form-label fw-bold">
              <i class="fas fa-calendar-alt me-1"></i> Date Posted
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Filter by job posting date"></i>
            </label>
            <select class="form-select" id="id_date_range" name="date_range">
              <option value="24hours" {% if filter.date_range == '24hours' %}selected{% endif %}>Last 24 hours</option>
              <option value="72hours" {% if filter.date_range == '72hours' %}selected{% endif %}>Last 3 days</option>
              <option value="week" {% if filter.date_range == 'week' %}selected{% endif %}>Last 7 days</option>
              <option value="month" {% if filter.date_range == 'month' %}selected{% endif %}>Last 30 days</option>
              <option value="all" {% if filter.date_range == 'all' or not filter.date_range %}selected{% endif %}>All time</option>
                                </select>
                            </div>
                        </div>
        
        <div class="col-md-6">
                            <div class="form-group">
            <label for="id_job_board" class="form-label fw-bold">
              <i class="fas fa-bullhorn me-1"></i> Job Portal
              <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" title="Select which job portal to search in"></i>
            </label>
            <select class="form-select" id="id_job_board" name="job_board">
              <option value="All" {% if not filter.job_boards.all %}selected{% endif %}>All Job Portals</option>
              {% for portal in job_portals %}
                <option value="{{ portal.name }}" 
                  {% if filter.job_boards.all|length == 1 and filter.job_boards.first.name == portal.name %}selected{% endif %}>
                  {{ portal.name }}
                                            </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
        
        <!-- Action Buttons -->
        <div class="col-12 mt-4 d-flex flex-column flex-md-row justify-content-between align-items-center">
          <div class="d-flex gap-2 mb-3 mb-md-0">
            <div class="dropdown">
              <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-folder-open me-1"></i> Saved Filters
              </button>
              <ul class="dropdown-menu">
                {% if saved_filters %}
                  {% for saved in saved_filters %}
                    <li>
                      <a class="dropdown-item" href="{% url 'dashboard:load-filter' saved.id %}">
                        <i class="fas {% if saved.id == filter_id %}fa-check-circle text-success{% else %}fa-filter{% endif %} me-2"></i>
                        {{ saved.name }}
                      </a>
                    </li>
                  {% endfor %}
                {% else %}
                  <li><span class="dropdown-item disabled">No saved filters</span></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{% url 'dashboard:clear-filter' %}">
                    <i class="fas fa-times-circle me-2"></i> Clear Filter
                  </a>
                </li>
              </ul>
                    </div>
                    
            {% if is_saved_filter %}
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteFilterModal">
              <i class="fas fa-trash me-1"></i> Delete
            </button>
            {% endif %}
                            </div>
          
          <div class="d-grid d-md-block">
            <button type="button" class="btn btn-primary btn-lg px-4" id="startScraping">
              <i class="fas fa-search me-2"></i> Start Scraping
            </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

<!-- Save Filter Modal -->
<div class="modal fade" id="saveFilterModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Save Search Filter</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="filter_name" class="form-label">Filter Name</label>
          <input type="text" class="form-control" id="filter_name" placeholder="e.g., Technical Jobs in UK">
                </div>
        <div class="form-text text-muted mt-2">
          <i class="fas fa-info-circle me-1"></i> This will save your current search filters for future use
        </div>
            </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveFilterBtn">Save Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Filter Modal -->
{% if is_saved_filter %}
<div class="modal fade" id="deleteFilterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Delete Filter</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
        <p>Are you sure you want to delete the filter <strong>"{{ filter.name }}"</strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="{% url 'dashboard:delete-filter' filter.id %}" class="btn btn-danger">Delete Filter</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Keyword suggestion buttons
    document.querySelectorAll('.keyword-suggestion').forEach(function(button) {
      button.addEventListener('click', function() {
        const keyword = this.getAttribute('data-keyword');
        const keywordsField = document.getElementById('id_keywords');
        const currentKeywords = keywordsField.value.trim();
        
        if (currentKeywords) {
          keywordsField.value = currentKeywords + ', ' + keyword;
        } else {
          keywordsField.value = keyword;
        }
      });
    });
    
    // Save filter button
    document.getElementById('saveFilterBtn').addEventListener('click', function() {
      const filterName = document.getElementById('filter_name').value.trim();
      if (!filterName) {
        alert('Please enter a name for this filter');
        return;
      }
      
      document.getElementById('id_name').value = filterName;
      document.querySelector('.search-filter-form').submit();
    });
    
    // Start scraping button
    document.getElementById('startScraping').addEventListener('click', function() {
      const form = document.querySelector('.search-filter-form');
      form.action = "{% url 'dashboard:start-scraping' %}";
      form.submit();
    });
});
</script>